#!/usr/bin/env bash
set -euo pipefail

[[ $# -eq 0 ]] && { echo "usage: tmuxify <cmd> [name]" >&2; exit 1; }

cmd=$1
name=${2:-$cmd}
session=${name//\//-}

if [[ $# -eq 1 ]]; then
  tmux new-session -A -s "$session" "$cmd"
  exit 0
fi

# Create worktree if we're in a git repo
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  repo_root=$(git rev-parse --show-toplevel)
  repo_name=$(basename "$repo_root")
  wt_path="$(dirname "$repo_root")/${repo_name}-${session}"

  if [[ ! -d "$wt_path" ]]; then
    wt -b main "$name"
  fi

  tmux new-session -A -s "$session" -c "$wt_path" "$cmd"
else
  tmux new-session -A -s "$session" "$cmd"
fi
