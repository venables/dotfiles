#!/usr/bin/env bash

#
# See <https://voz.dev/articles/git/wt>
#

set -euo pipefail

show_help() {
  cat <<'EOF'
Usage: wt <command> [options]
Commands:
  list|ls                    Show active worktrees
  add|new [-b base] [path]   Add a worktree for <branch>; defaults path to ../<repo>-<branch>
  remove|rm <path|branch>    Remove a worktree by path or branch name
  prune                      Run git worktree prune
Examples:
  wt list
  wt add feature/login
  wt add -b main feature/login ../product-site-login
  wt remove feature/login
EOF
}

[[ $# -eq 0 || "$1" =~ ^(help|--help)$ ]] && { show_help; exit 0; }

git rev-parse --is-inside-work-tree >/dev/null 2>&1 || { echo "wt: run inside a git repository" >&2; exit 1; }

repo_root=$(git rev-parse --show-toplevel)
repo_name=$(basename "$repo_root")
cmd=$1; shift

case "$cmd" in
list|ls) git worktree list "$@" ;;
prune) git worktree prune "$@" ;;
add|new)
  base="" path=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -b|--base) base=$2; shift 2 ;;
      -p|--path) path=$2; shift 2 ;;
      -h|--help) show_help; exit 0 ;;
      *) [[ -z "${branch:-}" ]] && branch=$1 || path=$1; shift ;;
    esac
  done
  [[ -z "${branch:-}" ]] && { echo "wt add: branch name required" >&2; exit 1; }
  : "${path:=$(dirname "$repo_root")/${repo_name}-${branch//\//-}}"

  if git show-ref --verify --quiet "refs/heads/$branch"; then
    git worktree add "$path" "$branch"
  elif git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
    git worktree add --track -b "$branch" "$path" "origin/$branch"
  elif [[ -n "$base" ]]; then
    git worktree add -b "$branch" "$path" "$base"
  else
    echo "wt add: branch '$branch' not found. Use --base <existing-branch> to create it." >&2
    exit 1
  fi
  ;;
remove|rm)
  [[ $# -eq 0 ]] && { echo "wt remove: provide a path or branch name" >&2; exit 1; }
  input=$1
  if [[ -d "$input" ]]; then
    target=$input
  else
    target=$(git worktree list --porcelain | awk -v b="$input" '/^worktree /{w=$2} /^branch /{gsub(/refs\/heads\//,"",$2); if($2==b){print w;exit}}')
    [[ -z "$target" ]] && guess="$(dirname "$repo_root")/${repo_name}-${input//\//-}" && [[ -d "$guess" ]] && target=$guess
  fi
  [[ -z "${target:-}" ]] && { echo "wt remove: unable to resolve worktree for '$input'" >&2; exit 1; }
  git worktree remove "$target"
  ;;
*) echo "wt: unknown command '$cmd'. See 'wt help'." >&2; exit 1 ;;
esac
